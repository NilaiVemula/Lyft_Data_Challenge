---
title: "10_Importing_Data"
output: html_notebook
---

# Import Libraries
`tidyverse` is a collection of packages for R designed with a consistent methodology.

```{r setup}
require(tidyverse)
```

# Import Dataset
`readr` is used to import the datasets. Take note of the datetime format and the factor levels for events
```{r import data files}
driver_ids <- read_csv("data/driver_ids.csv", 
    col_types = cols(driver_onboard_date = col_datetime(format = "%Y-%m-%d %H:%M:%S")))

ride_ids <- read_csv("data/ride_ids.csv", 
    col_types = cols(driver_id = col_character(), 
        ride_distance = col_double(), ride_duration = col_double(), 
        ride_id = col_character(), ride_prime_time = col_double()))

ride_timestamps <- read_csv("data/ride_timestamps.csv", 
    col_types = cols(event = col_factor(levels = c("requested_at", 
        "accepted_at", "arrived_at", "picked_up_at", 
        "dropped_off_at")), ride_id = col_character(), 
        timestamp = col_datetime(format = "%Y-%m-%d %H:%M:%S")))
```

# Preview Data
```{r}
driver_ids
```

There are 937 drivers.

```{r}
ride_ids
```

There are 193,502 rides.

```{r}
ride_timestamps
```

```{r}
ride_timestamps %>% filter(is.na(timestamp))
```


```{r}
library(lubridate)
last_timestamp <- ride_timestamps %>% drop_na()
last_recorded_timestamp <- (max(last_timestamp$timestamp))
last_recorded_timestamp

first_recorded_timestamp <- (min(last_timestamp$timestamp))
first_recorded_timestamp
```


```{r}
rides <- left_join(ride_ids,ride_timestamps,by="ride_id")
rides
```

```{r}
rides %>% filter(is.na(timestamp)) %>% select(driver_id) %>% distinct()
```


# Combine Data into full dataset
```{r}
full <- left_join(rides,driver_ids,by="driver_id")
full
```


```{r}
full %>% filter(is.na(timestamp))
```



```{r}
driver_lengths <- full %>% filter(event == "dropped_off_at") %>% mutate(time_from_employment_to_current_ride = timestamp-driver_onboard_date) %>% select(driver_id, time_from_employment_to_current_ride, time_of_current_ride=timestamp )
driver_lengths
```


```{r}
driver_time_distributions <- driver_lengths %>% 
  drop_na() %>% 
  group_by(driver_id) %>%
  arrange(driver_id,time_from_employment_to_current_ride)
driver_time_distributions
```

```{r}

first_driver <- driver_lengths %>%
  drop_na() %>% 
  group_by(driver_id) %>% 
  arrange(time_of_current_ride) %>% 
  filter(driver_id == "002be0ffdc997bd5c50703158b7c2491") %>% 
  select(time_from_employment_to_current_ride) %>% 
  mutate_all(funs(. - lag(.))) %>% # subtract by previous value to get time between rides
  na.omit() %>% 
  select(time_between_rides = time_from_employment_to_current_ride)

first_driver %>% ggplot(aes(time_between_rides)) +
  geom_density() 

#+
 # coord_cartesian(xlim = c(0, 600)) 



```
5 hour cut off

```{r}

significant_time_between_sessions_set <- driver_lengths %>%
  drop_na() %>% 
  group_by(driver_id) %>% 
  arrange(driver_id,time_from_employment_to_current_ride) %>% 
  mutate(time_between_sessions = time_from_employment_to_current_ride-lag(time_from_employment_to_current_ride)) %>% 
  drop_na() %>% 
  select(driver_id, time_between_sessions,time_of_current_ride) %>% 
  
  arrange(driver_id,desc(time_of_current_ride)) %>% 
  dplyr::mutate(
        last_break = a - dplyr::first(time_of_current_ride)
    ) %>% 
  filter(time_between_sessions>300) %>% 
  mutate(mean = mean(time_between_sessions)) %>% 
  mutate(sd = sd(time_between_sessions)) %>% 
  mutate(size = n()) %>%
  filter(last_break>mean+2*sd) #only chose significant breaks
# %>% 
  # select(driver_id) %>% 
  # distinct(driver_id)

    # mutate(t=(mean-last_break)/(sd/sqrt(size))) %>% 
  # mutate(p = 2*pt(t, size-1, lower=FALSE)) %>% 
  # filter(p<0.05)



  
significant_time_between_sessions_set

```

```{r}
list_of_quitters <- significant_time_between_sessions_set %>% select(driver_id) %>% distinct()
```


```{r}
career_length_so_far <- driver_lengths %>% drop_na() %>% 
  group_by(driver_id) %>% 
  summarise(length = max(time_from_employment_to_current_ride))
  
career_length_so_far
```

```{r}

p <- career_length_so_far %>% 
  ggplot(aes(length)) +
  geom_histogram(binwidth=10080)
p
```

```{r}
quitter_career_lengths <- left_join(list_of_quitters,career_length_so_far)
quitter_career_lengths

quitters_plot<- quitter_career_lengths %>% 
  ggplot(aes(length)) +
  geom_histogram(binwidth=10080)
quitters_plot
```

```{r}
quit_avg <- quitter_career_lengths %>% ungroup() %>% summarise(mean(length))
quit_avg
```

